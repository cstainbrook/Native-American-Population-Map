<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <script src="http://d3js.org/d3.v3.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
  <script src="http://dimplejs.org/dist/dimple.v2.3.0.min.js"></script>
  <!-- <link href='native_map.css' rel="stylesheet" type="text/css"> -->
  <style>
  h1{
      text-align: center;
      font-size: 300%
  }
  h2{
      text-align: center;
  }
  div.population_line{
      position: fixed;
      right:5%;
      top: 14%;
  }
  div.years_buttons{
      position: fixed;
      top: 20%;
      left: 1%;
  }
  div.years_buttons div{
      background-color: BurlyWood;
      opacity: .9;
      border: 2px;
      border-radius: 7px;
      color: black;
      padding: 5px;
      margin: 15px;
      font-weight: bold;
  }
  g.legend{
      position: fixed;
      top: 25%;
      left: 14%;
  }
  .x_axis line{
      fill: none;
      stroke: black;
      stroke-width: 1;
      shape-rendering: auto;
  }
  .x_axis text{
      font-family: sans-serif;
      font-size: 12px;
  }
  .y_axis line{
      fill: none;
      stroke: black;
      stroke-width: 1;
      shape-rendering: auto;
  }
  .y_axis text{
      font-family: sans-serif;
      font-size: 12px;
  }
  #county_instruction{
      opacity: .9;
      position: fixed;
      right:4%;
      top: 25%;
      background-color: BurlyWood;
      border: 2px;
      border-radius: 7px;
      padding: 15px;
      margin: 35px;
  }
  .county_info_buttons{
      position: fixed;
      top: 86%;
      right: 8%;
  }
  .county_info_buttons div{
      background-color: BurlyWood;
      opacity: .9;
      border: 2px;
      border-radius: 7px;
      float: left;
      color: black;
      padding: 5px;
      margin: 15px;
      font-weight: bold;
  }
  .county_info_buttons2{
      position: fixed;
      top: 92%;
      right: 3%;
  }
  .county_info_buttons2 div{
      background-color: BurlyWood;
      opacity: .9;
      border: 2px;
      border-radius: 7px;
      float: left;
      color: black;
      padding: 5px;
      margin: 15px;
      font-weight: bold;
  }
  </style>
  <script type='text/javascript'>
      function draw(geo_data) {
          d3.select('h1')
              .text('Native American Population');

          var width = 850,
              height = 450;

          var svg = d3.select('.map_holder')
                      .append('svg')
                      .attr('width', width)
                      .attr('height', height)
                      .append('g')
                      .attr('class', 'map');

          var projection = d3.geo.mercator()
                                 .scale(750)
                                 .translate([width * 2.02, height * 1.7]);

          var path = d3.geo.path().projection(projection);

          function plot_gender(d, line_data, label) {
              d3.select('h2').remove()
              d3.selectAll('.population_point').remove()
              d3.select('#line_svg').remove()
              d3.select('#county_instruction').remove()

              var x_scale = d3.scale.linear().range([0,400]).domain([d3.min(line_data, function(d){ return (d['x'] - 5) }), d3.max(line_data, function(d){ return (d['x'] + 5) })])

              var y_scale = d3.scale.linear().range([300,0]).domain([d3.min(line_data, function(d){ return (d['y'] - .1*d['y']) }), d3.max(line_data, function(d){ return (d['y'] + .1*d['y']) })])

              d3.select('.population_line')
                .append('h2')
                .html(label + ' Over Time:' + '<br/>' + d.properties.NAME + ' County')

              var line_holder = d3.select('.population_line')
                                  .append('svg')
                                  .attr('width', 350)
                                  .attr('height', 350)
                                  .attr('id', 'line_svg')
            //   line_holder.selectAll('circle')
            //              .data(line_data)
            //              .enter()
            //              .append('circle')
            //              .attr('class', 'population_point')
            //              .attr('cx', function(d) {
            //                  return x_scale(d['x'])
            //              })
            //              .attr('cy', function(d) {
            //                  return y_scale(d['y'])
            //                  }
            //              })
            //              .attr('r', 3)
              //
            //   var linefunc = d3.svg.line()
            //                        .x(function(d) {
            //                            return x_scale(d['x'])
            //                        })
            //                        .y(function(d) {
            //                            return y_scale(d['y'])
            //                        })
            //                        .interpolate('linear')
              //
            //   line_holder.append('path')
            //              .attr('d', linefunc(line_data))
            //              .attr('stroke-width', 2)
            //              .attr('stroke', 'black')
            //              .attr('fill', 'none')

              var x_axis = d3.svg.axis()
                                  .scale(x_scale)
                                  .tickSize(5)
                                  .tickSubdivide(true)
                                  .tickFormat(d3.format("d"))

              var y_axis = d3.svg.axis()
                                  .scale(y_scale)
                                  .tickSize(5)
                                  .orient('left')
                                  .tickSubdivide(true)

              line_holder.append('g')
                          .attr('class', 'x_axis')
                          .attr('transform', 'translate(0, 300)')
                          .attr('stroke-width', 2)
                          .call(x_axis)
                          .selectAll("text")
                          .style("text-anchor", "end")
                          .attr("dx", "-.8em")
                          .attr("dy", ".15em")
                          .attr("transform", "rotate(-65)");

              line_holder.append('g')
                          .attr('class', 'y_axis')
                          .attr('transform', 'translate(50, 0)')
                          .attr('stroke-width', 2)
                          .call(y_axis)
          };

          function update_line_plot(d, line_data, label) {
              d3.select('h2').remove()
              d3.selectAll('.population_point').remove()
              d3.select('#line_svg').remove()
              d3.select('#county_instruction').remove()

              var x_scale = d3.scale.linear().range([0,400]).domain([d3.min(line_data, function(d){ return (d['x'] - 5) }), d3.max(line_data, function(d){ return (d['x'] + 5) })])

              var y_scale = d3.scale.linear().range([300,0]).domain([d3.min(line_data, function(d){ return (d['y'] - .1*d['y']) }), d3.max(line_data, function(d){ return (d['y'] + .1*d['y']) })])

              d3.select('.population_line')
                .append('h2')
                .html(label + ' Over Time:' + '<br/>' + d.properties.NAME + ' County')

              var line_holder = d3.select('.population_line')
                                  .append('svg')
                                  .attr('width', 350)
                                  .attr('height', 350)
                                  .attr('id', 'line_svg')

              line_holder.selectAll('circle')
                         .data(line_data)
                         .enter()
                         .append('circle')
                         .attr('class', 'population_point')
                         .attr('cx', function(d) {
                             return x_scale(d['x'])
                         })
                         .attr('cy', function(d) {
                             return y_scale(d['y'])
                         })
                         .attr('r', 3)

              var linefunc = d3.svg.line()
                                   .x(function(d) {
                                       return x_scale(d['x'])
                                   })
                                   .y(function(d) {
                                       return y_scale(d['y'])
                                   })
                                   .interpolate('linear')

              line_holder.append('path')
                         .attr('d', linefunc(line_data))
                         .attr('stroke-width', 2)
                         .attr('stroke', 'black')
                         .attr('fill', 'none')

              var x_axis = d3.svg.axis()
                                  .scale(x_scale)
                                  .tickSize(5)
                                  .tickSubdivide(true)
                                  .tickFormat(d3.format("d"))

              var y_axis = d3.svg.axis()
                                  .scale(y_scale)
                                  .tickSize(5)
                                  .orient('left')
                                  .tickSubdivide(true)

              line_holder.append('g')
                          .attr('class', 'x_axis')
                          .attr('transform', 'translate(0, 300)')
                          .attr('stroke-width', 2)
                          .call(x_axis)
                          .selectAll("text")
                          .style("text-anchor", "end")
                          .attr("dx", "-.8em")
                          .attr("dy", ".15em")
                          .attr("transform", "rotate(-65)");

              line_holder.append('g')
                          .attr('class', 'y_axis')
                          .attr('transform', 'translate(50, 0)')
                          .attr('stroke-width', 2)
                          .call(y_axis)
          };

          var map = svg.selectAll('path')
              .data(geo_data.features)
              .enter()
              .append('path')
              .attr('class', 'us_counties')
              .attr('d', path)
              .attr('fill', 'maroon')
              .style('stroke-width', 0.5)
              .on('click', function(d){
                  debugger;
                  d3.select('h2').remove()
                  d3.selectAll('.population_point').remove()
                  d3.select('#line_svg').remove()
                  d3.select('#county_instruction').remove()

                  var population_line_data = []
                  var female_no_high_school = []
                  var female_high_school = []
                  var female_some_college = []
                  var female_college = []

                  var line_years = [1990, 2000, 2009, 2010, 2011, 2012, 2013, 2014, 2015]

                  for (i=0; i<line_years.length; i++) {
                      if(typeof d.properties[line_years[i]] !== 'undefined') {
                          population_line_data.push({x: line_years[i], y: +d.properties[line_years[i]]})
                        }
                  }

                  for (i=0; i<line_years.length; i++) {
                      if(typeof d.properties[line_years[i] + ': Female Less than High School'] !== 'undefined') {
                          female_no_high_school.push({x: line_years[i], y: +d.properties[line_years[i] + ': Female Less than High School']})
                      }
                  }
                  debugger;
                  update_line_plot(d, population_line_data, 'Population')

                  var county_options = ['Population', 'Age', 'Male Age']
                  var county_options2 = ['Female Age', 'Poverty Rate', 'Median Income']

                  var county_info_buttons = d3.select('.population_line')
                      .append('div')
                      .attr('class', 'county_info_buttons')
                      .selectAll('div')
                      .data(county_options)
                      .enter()
                      .append('div')
                      .text(function(d) {
                          return d;
                      });

                  county_info_buttons.on('click', function(j) {
                      d3.selectAll('.county_info_buttons')
                        .selectAll('div')
                        .style('background-color', 'BurlyWood')
                        .style('color', 'black')
                      d3.selectAll('.county_info_buttons2')
                        .selectAll('div')
                        .style('background-color', 'BurlyWood')
                        .style('color', 'black')
                      d3.select(this)
                        .transition()
                        .duration(500)
                        .style('background-color', 'Maroon')
                        .style('color', 'white');
                      if (this.textContent === 'Population') {
                          update_line_plot(d, population_line_data, 'Population')
                      }
                  });

                  var county_info_buttons2 = d3.select('.population_line')
                      .append('div')
                      .attr('class', 'county_info_buttons2')
                      .selectAll('div')
                      .data(county_options2)
                      .enter()
                      .append('div')
                      .text(function(d) {
                          return d;
                      });

                  county_info_buttons2.on('click', function(j) {
                      d3.selectAll('.county_info_buttons')
                        .selectAll('div')
                        .style('background-color', 'BurlyWood')
                        .style('color', 'black')
                      d3.selectAll('.county_info_buttons2')
                        .selectAll('div')
                        .style('background-color', 'BurlyWood')
                        .style('color', 'black')
                      d3.select(this)
                        .transition()
                        .duration(500)
                        .style('background-color', 'Maroon')
                        .style('color', 'white');
                      if (this.textContent === 'Female Age') {
                        plot_gender(d, female_no_high_school, 'Female Education')
                      }
                  });
              });

          var population_scale = d3.scale.threshold().domain([1000, 5000, 10000, 50000]).range([.2, .4, .6, .8])

          var legend_data = [0, 1000, 5000, 10000, 50000]
          var legend_labels = ['<1,000', '1,000-5,000', '5,000-10,000', '10,000-50,000', '50,000+']

          var legend = svg.selectAll('g.legend')
                          .data(legend_data)
                          .enter()
                          .append('g')
                          .attr('class', 'legend')

          var ls_w = 20, ls_h = 20;

          legend.append("rect")
                  .attr("x", 710)
                  .attr("y", function(d, i){ return height - 30 - (i*ls_h) - 2*ls_h;})
                  .attr("width", ls_w)
                  .attr("height", ls_h)
                  .style("fill", 'maroon')
                  .style("opacity", function(d, i) {
                      return population_scale(d);
                  });

          legend.append("text")
                  .attr("x", 740)
                  .attr("y", function(d, i){ return height - 30 - (i*ls_h) - ls_h - 4;})
                  .text(function(d, i){ return legend_labels[i]; });

          function update_colors(pop_data, year) {
              d3.select('h1')
                  .text('Native American Population ' + year)

              function merge_json(year) {
                  for (var i=0; i<geo_data.features.length; i++) {
                      var merge_id = geo_data.features[i].properties.GEOID
                      for (var j=0; j<pop_data.length; j++) {
                          if (pop_data[j].GEOID === merge_id) {
                              geo_data.features[i].properties[year] = pop_data[j].population
                          }
                      }
                  }
              };

              merge_json(year)

              svg.selectAll('path')
                  .transition()
                  .duration(1500)
                  .style('opacity', function(d){
                      return population_scale(d.properties[year])
                  })
          };

          function get_population(year) {
              if (year === 1990) {
                  d3.json('http://api.census.gov/data/' + year + '/sf1?get=ANPSADPI,P0070003&for=county:*&key=', function(json){
                      var jsonArr = [];
                      json.forEach(function(d,i) {
                          jsonArr.push({
                              GEOID: d[2] + d[3],
                              population: d[1]
                          })
                      });
                      jsonArr.splice(0,1)
                      update_colors(jsonArr, year);
                  });
              } else if (year === 2000) {
                  d3.json('http://api.census.gov/data/' + year + '/sf1?get=NAME,H011C001&for=county:*&key=', function(json){
                      var jsonArr = [];
                      json.forEach(function(d,i) {
                          jsonArr.push({
                              GEOID: d[2] + d[3],
                              population: d[1]
                          })
                      });
                      jsonArr.splice(0,1)
                      update_colors(jsonArr, year);
                  });
              } else {
                  d3.json('http://api.census.gov/data/' + year + '/acs5?get=NAME,B01001C_001E&for=county:*&key=', function(json){
                      var jsonArr = [];
                      json.forEach(function(d,i) {
                          jsonArr.push({
                              GEOID: d[2] + d[3],
                              population: d[1]
                          })
                      });
                      jsonArr.splice(0,1)
                      update_colors(jsonArr, year);
                  });
              }
          };

          function get_attribute(year, api_code, label) {
              function merge_attribute(attributeArr, year, label) {
                  for (var i=0; i<geo_data.features.length; i++) {
                      var merge_id = geo_data.features[i].properties.GEOID
                      for (var j=0; j<attributeArr.length; j++) {
                          if (attributeArr[j].GEOID === merge_id) {
                              geo_data.features[i].properties[year + ': ' + label] = attributeArr[j].attribute
                          }
                      }
                  }
              };

              if (year === 1990) {
                  d3.json('http://api.census.gov/data/' + year + '/sf1?get=NAME,' + api_code + '&for=county:*&key=', function(json){
                      var attributeArr = [];
                      json.forEach(function(d,i) {
                          attributeArr.push({
                              GEOID: d[2] + d[3],
                              attribute: d[1]
                          })
                      });
                      attributeArr.splice(0,1)
                      merge_attribute(attributeArr, year, label)
                  });
              } else if (year === 2000){
                  d3.json('http://api.census.gov/data/' + year + '/sf1?get=NAME,' + api_code + '&for=county:*&key=', function(json){
                      var attributeArr = [];
                      json.forEach(function(d,i) {
                          attributeArr.push({
                              GEOID: d[2] + d[3],
                              attribute: d[1]
                          })
                      });
                      attributeArr.splice(0,1)
                      merge_attribute(attributeArr, year, label)
                  });
              } else{
                  d3.json('http://api.census.gov/data/' + year + '/acs5?get=NAME,' + api_code + '&for=county:*&key=', function(json){
                      var attributeArr = [];
                      json.forEach(function(d,i) {
                          attributeArr.push({
                              GEOID: d[2] + d[3],
                              attribute: d[1]
                          })
                      });
                      attributeArr.splice(0,1)
                      merge_attribute(attributeArr, year, label);
                  })
              };
          }

          var years = [1990, 2000, 2009, 2010, 2011, 2012, 2013, 2014, 2015];

          var year_index = 0

          var year_interval = setInterval(function() {
              if (years[year_index] === 2000) {
                  get_attribute(years[year_index], 'P012C026', 'Female Population')
                  get_attribute(years[year_index], 'P012C002', 'Male Population')
                  get_attribute(years[year_index], 'P013C001', 'Median Age')
                  get_attribute(years[year_index], 'P013C003', 'Female Median Age')
                  get_attribute(years[year_index], 'P013C002', 'Male Median Age')
              } else {
                  get_attribute(years[year_index], 'B01001C_017E', 'Female Population')
                  get_attribute(years[year_index], 'B01001C_002E', 'Male Population')
                  get_attribute(years[year_index], 'B01002C_001E', 'Median Age')
                  get_attribute(years[year_index], 'B01002C_003E', 'Female Median Age')
                  get_attribute(years[year_index], 'B01002C_002E', 'Male Median Age')
                  get_attribute(years[year_index], 'B17001C_002E', 'Population in Poverty')
                  get_attribute(years[year_index], 'B17001C_032E', 'Population Above Poverty')
                  get_attribute(years[year_index], 'C15002C_003E', 'Male Less than High School')
                  get_attribute(years[year_index], 'C15002C_004E', 'Male High School')
                  get_attribute(years[year_index], 'C15002C_005E', 'Male Some College')
                  get_attribute(years[year_index], 'C15002C_006E', 'Male College or Higher')
                  get_attribute(years[year_index], 'C15002C_008E', 'Female Less than High School')
                  get_attribute(years[year_index], 'C15002C_009E', 'Female High School')
                  get_attribute(years[year_index], 'C15002C_010E', 'Female Some College')
                  get_attribute(years[year_index], 'C15002C_011E', 'Female College or Higher')
              };

              get_population(years[year_index]);
              year_index++;
              if(year_index >= years.length) {
                  clearInterval(year_interval);

                  d3.select('.population_line')
                    .append('h2')
                    .attr('id', 'county_instruction')
                    .html('Click on a County to' + '</br>' + 'View County Specific' + '</br>' + 'Population Over Time' + '</br></br>' + 'or Click on a Year to' + '</br>' + 'View the Map for' + '</br>' + 'that Given Year')

                  var buttons = d3.select('body')
                      .append('div')
                      .attr('class', 'years_buttons')
                      .selectAll('div')
                      .data(years)
                      .enter()
                      .append('div')
                      .text(function(d) {
                          return d;
                      });

                  buttons.on('click', function(d) {
                      d3.selectAll('.years_buttons')
                        .selectAll('div')
                        .style('background-color', 'BurlyWood')
                        .style('color', 'black');

                      d3.select(this)
                        .transition()
                        .duration(500)
                        .style('background-color', 'Maroon')
                        .style('color', 'white');

                      get_population(d)
                  });
              }
          }, 2000)
      };
  </script>
</head>
<body>
    <h1></h1>
    <div class='map_holder'></div>
    <div class='population_line'></div>
    <script type='text/javascript'>
        d3.json('us_counties.json', draw);
    </script>
</body>
</html>

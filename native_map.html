<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <script src="http://d3js.org/d3.v3.min.js"></script>
    <style>
    h1{
        text-align: center;
        font-size: 300%
    }
    div.years_buttons{
        position: fixed;
        top: 25%;
        left: 14%;
    }
    div.years_buttons div{
        background-color: BurlyWood;
        opacity: .9;
        border: 2px;
        border-radius: 7px;
        color: black;
        padding: 5px;
        margin: 15px;
        font-weight: bold;
    }
    g.legend{
        position: fixed;
        top: 25%;
        left: 14%;
    }
    </style>
    <script type="text/javascript">

    function draw(geo_data) {
        d3.select('body')
            .append('h1')
            .text('Native American Population');

        var width = 1400,
            height = 500;

        var svg = d3.select('body')
                    .append('svg')
                    .attr('width', width)
                    .attr('height', height)
                    .append('g')
                    .attr('class', 'map');

        var projection = d3.geo.mercator()
                               .scale(850)
                               .translate([width * 1.55, height * 1.73]);

        var path = d3.geo.path().projection(projection);

        var map = svg.selectAll('path')
            .data(geo_data.features)
            .enter()
            .append('path')
            .attr('class', 'us_counties')
            .attr('d', path)
            .attr('fill', 'maroon')
            .style('stroke-width', 0.5);

        var population_scale = d3.scale.threshold().domain([1000, 5000, 10000, 50000]).range([.2, .4, .6, .8])

        var legend_data = [0, 1000, 5000, 10000, 50000]
        var legend_labels = ['<1,000', '1,000-5,000', '5,000-10,000', '10,000-50,000', '50,000+']

        var legend = svg.selectAll('g.legend')
                        .data(legend_data)
                        .enter()
                        .append('g')
                        .attr('class', 'legend')

        var ls_w = 20, ls_h = 20;

        legend.append("rect")
                .attr("x", 1120)
                .attr("y", function(d, i){ return height - 50 - (i*ls_h) - 2*ls_h;})
                .attr("width", ls_w)
                .attr("height", ls_h)
                .style("fill", 'maroon')
                .style("opacity", function(d, i) {
                    return population_scale(d);
                });

        legend.append("text")
                .attr("x", 1150)
                .attr("y", function(d, i){ return height - 50 - (i*ls_h) - ls_h - 4;})
                .text(function(d, i){ return legend_labels[i]; });

        function update_colors(pop_data, year) {
            d3.select('h1')
                .text('Native American Population ' + year)

            function merge_json(year) {
                for (var i=0; i<geo_data.features.length; i++) {
                    var merge_id = geo_data.features[i].properties.GEOID
                    for (var j=0; j<pop_data.length; j++) {
                        if (pop_data[j].GEOID === merge_id) {
                            geo_data.features[i].properties[year] = pop_data[j].population
                        }
                    }
                }
            };

            merge_json(year)

            svg.selectAll('path')
                .transition()
                .duration(1500)
                .style('opacity', function(d){
                    return population_scale(d.properties[year])
                })
        };

        function get_population(year) {
            d3.json('http://api.census.gov/data/' + year + '/acs5?get=NAME,B01001C_001E&for=county:*', function(json){
                var jsonArr = [];
                json.forEach(function(d,i) {
                    jsonArr.push({
                        GEOID: d[2] + d[3],
                        population: d[1]
                    })
                });
                jsonArr.splice(0,1)
                update_colors(jsonArr, year);
            });
        };

        var years = [];

        for (var i = 2009; i < 2016; i++) {
            years.push(i);
        };

        var year_index = 0

        var year_interval = setInterval(function() {
            get_population(years[year_index]);
            year_index++;
            if(year_index >= years.length) {
                clearInterval(year_interval);
                var buttons = d3.select('body')
                    .append('div')
                    .attr('class', 'years_buttons')
                    .selectAll('div')
                    .data(years)
                    .enter()
                    .append('div')
                    .text(function(d) {
                        return d;
                    });

                buttons.on('click', function(d) {
                    d3.selectAll('.years_buttons')
                      .selectAll('div')
                      .style('background-color', 'BurlyWood')
                      .style('color', 'black');

                    d3.select(this)
                      .transition()
                      .duration(500)
                      .style('background-color', 'Maroon')
                      .style('color', 'white');

                    get_population(d)
                });
            }
        }, 3000)
    };
    </script>
</head>
<body>
    <script type="text/javascript">
        var population_max = 0
        var population_min = 10000000000

        function update_min_max(year) {
            d3.json('http://api.census.gov/data/' + year + '/acs5?get=NAME,B01001C_001E&for=county:*', function(json){
                json.splice(0,1)
                var min_max_extent = d3.extent(json, function(d) {
                    return +d[1];
                });
                if (min_max_extent[0] < population_min) { population_min = min_max_extent[0] };
                if (min_max_extent[1] > population_max) { population_max = min_max_extent[1] };
            })
        };

        function update_for_year() {
            for (i=2009; i<2016; i++) {
                update_min_max(i);
                console.log(i);
            };
        };

        update_for_year()

        d3.json('us_counties.json', draw);
    </script>
</body>
</html>
